<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;tzxhy.github.io&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12,&quot;b2t&quot;:false,&quot;scrollpercent&quot;:false,&quot;onmobile&quot;:false},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;slideDownIn&quot;,&quot;post_body&quot;:&quot;slideDownIn&quot;,&quot;coll_header&quot;:&quot;slideLeftIn&quot;,&quot;sidebar&quot;:&quot;slideUpIn&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;Searching...&quot;,&quot;empty&quot;:&quot;We didn&#39;t find any results for the search: ${query}&quot;,&quot;hits_time&quot;:&quot;${hits} results found in ${time} ms&quot;,&quot;hits&quot;:&quot;${hits} results found&quot;}}</script>
<meta name="description" content="ng + node服务，导致ng报错：upstream提前关闭连接？大前提是ng作为反向代理，upstream为node集群。 出错的触发条件是：某处发给ng一个带乱码的url请求，被ng转向node集群。 背景介绍&amp;emsp;&amp;emsp;随着部门的web接口不断增多，java后端逐步向node迁移。在我大住宿，这个web接口有一个好听的名字：热狗。不，不对，它叫hotdog。即从这个状态：&amp;em">
<meta property="og:type" content="article">
<meta property="og:title" content="ng-nodejs偶发502">
<meta property="og:url" content="https://tzxhy.github.io/2019/03/07/ng-nodejs%E5%81%B6%E5%8F%91502/index.html">
<meta property="og:site_name" content="CMeUp">
<meta property="og:description" content="ng + node服务，导致ng报错：upstream提前关闭连接？大前提是ng作为反向代理，upstream为node集群。 出错的触发条件是：某处发给ng一个带乱码的url请求，被ng转向node集群。 背景介绍&amp;emsp;&amp;emsp;随着部门的web接口不断增多，java后端逐步向node迁移。在我大住宿，这个web接口有一个好听的名字：热狗。不，不对，它叫hotdog。即从这个状态：&amp;em">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-1.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-2.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-3.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-4.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-5.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-6.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-7.png">
<meta property="og:image" content="https://tzxhy.github.io/images/ng-8.png">
<meta property="article:published_time" content="2019-03-07T15:32:32.000Z">
<meta property="article:modified_time" content="2021-05-24T09:30:32.416Z">
<meta property="article:author" content="谭智轩">
<meta property="article:tag" content="nodejs">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="502">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tzxhy.github.io/images/ng-1.png">


<link rel="canonical" href="https://tzxhy.github.io/2019/03/07/ng-nodejs%E5%81%B6%E5%8F%91502/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;en&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;tzxhy.github.io&#x2F;2019&#x2F;03&#x2F;07&#x2F;ng-nodejs%E5%81%B6%E5%8F%91502&#x2F;&quot;,&quot;path&quot;:&quot;2019&#x2F;03&#x2F;07&#x2F;ng-nodejs偶发502&#x2F;&quot;,&quot;title&quot;:&quot;ng-nodejs偶发502&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>ng-nodejs偶发502 | CMeUp</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">CMeUp</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录一些学习心得，QQ:1139723651.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ng-node%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%AF%BC%E8%87%B4ng%E6%8A%A5%E9%94%99%EF%BC%9Aupstream%E6%8F%90%E5%89%8D%E5%85%B3%E9%97%AD%E8%BF%9E%E6%8E%A5%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">ng + node服务，导致ng报错：upstream提前关闭连接？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">背景介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E9%87%8D%E7%8E%B0"><span class="nav-number">1.2.</span> <span class="nav-text">故障重现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fix-problem"><span class="nav-number">1.3.</span> <span class="nav-text">fix problem</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-ops%E6%9F%A5ng%E6%97%A5%E5%BF%97"><span class="nav-number">1.3.1.</span> <span class="nav-text">Step.1 ops查ng日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-result"><span class="nav-number">1.3.2.</span> <span class="nav-text">Step.1_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-Nodejs%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9F%A5%E6%97%A5%E5%BF%97"><span class="nav-number">1.3.3.</span> <span class="nav-text">Step.2 Nodejs服务端查日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-result"><span class="nav-number">1.3.4.</span> <span class="nav-text">Step.2_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-3-ops%E4%BF%AE%E6%94%B9%E5%88%B0upstream%E4%B8%BA%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.3.5.</span> <span class="nav-text">Step.3 ops修改到upstream为长连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-3-result"><span class="nav-number">1.3.6.</span> <span class="nav-text">Step.3_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-4-%E6%9F%A5%E7%9C%8Bnode%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86"><span class="nav-number">1.3.7.</span> <span class="nav-text">Step.4 查看node服务的超时处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-4-result"><span class="nav-number">1.3.8.</span> <span class="nav-text">Step.4_result</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-5-%E7%BD%91%E7%BB%9C%E5%B1%82%E9%9D%A2%E2%80%94%E6%8A%93%E5%8C%85"><span class="nav-number">1.3.9.</span> <span class="nav-text">Step.5 网络层面—抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-6-%E4%B8%A4%E7%AB%AF%E5%90%84%E8%87%AA%E7%9A%84%E5%B0%9D%E8%AF%95"><span class="nav-number">1.3.10.</span> <span class="nav-text">Step.6 两端各自的尝试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E6%96%B9%E6%A1%88%E2%80%93node"><span class="nav-number">1.3.10.1.</span> <span class="nav-text">前端方案–node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ops%E6%96%B9%E6%A1%88%E2%80%93ng"><span class="nav-number">1.3.10.2.</span> <span class="nav-text">ops方案–ng</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">谭智轩</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">82</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/tzxhy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tzxhy" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.cn/user/1820446984508072" title="掘金 → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;1820446984508072" rel="noopener" target="_blank">掘金</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.yuque.com/tanzhixuan-zebzs" title="语雀 → https:&#x2F;&#x2F;www.yuque.com&#x2F;tanzhixuan-zebzs" rel="noopener" target="_blank">语雀</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://tzxhy.github.io/2019/03/07/ng-nodejs%E5%81%B6%E5%8F%91502/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="谭智轩">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMeUp">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ng-nodejs偶发502
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-03-07 15:32:32" itemprop="dateCreated datePublished" datetime="2019-03-07T15:32:32Z">2019-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%A1%88%E4%BE%8B/" itemprop="url" rel="index"><span itemprop="name">案例</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="ng-node服务，导致ng报错：upstream提前关闭连接？"><a href="#ng-node服务，导致ng报错：upstream提前关闭连接？" class="headerlink" title="ng + node服务，导致ng报错：upstream提前关闭连接？"></a>ng + node服务，导致ng报错：upstream提前关闭连接？</h1><p>大前提是ng作为反向代理，upstream为node集群。</p>
<p>出错的触发条件是：某处发给ng一个带乱码的url请求，被ng转向node集群。</p>
<h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>&emsp;&emsp;随着部门的web接口不断增多，java后端逐步向node迁移。在我大住宿，这个web接口有一个好听的名字：热狗。不，不对，它叫hotdog。即从这个状态：<br><br /><br><img src="/images/ng-1.png" alt="ng"><br>&emsp;&emsp;变为了这个状态：<br><img src="/images/ng-2.png" alt="ng"><br>&emsp;&emsp;我们需要做的，就是搭建node服务，作为客户端和WEB_HOTDOG的通讯桥梁。</p>
<p>&emsp;&emsp;考虑到负载均衡，一般会采用类似nginx的软件作为反向代理。同时源服务器一般会有多台，所以经常看到这样的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream node_server &#123;</span><br><span class="line">    server 111.111.111.10:6666;</span><br><span class="line">    server 111.111.111.11:6666;</span><br><span class="line">    server 111.111.111.12:6666;</span><br><span class="line">    server 111.111.111.13:6666;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    location /interface/to/location &#123;</span><br><span class="line">        proxy_pass http://node_server;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;即对/interface/to/location的请求会被转发到upstream  node_server上，当然详细的配置还有很多。</p>
<span id="more"></span>

<h2 id="故障重现"><a href="#故障重现" class="headerlink" title="故障重现"></a>故障重现</h2><p>&emsp;&emsp;配置好ng，部署好工程，万事俱备，只差验收了。然而，当访问新增的Node接口时，总是__时不时__的返回502！<br><img src="/images/ng-3.png" alt="ng"><br>&emsp;&emsp;还有一个现象：当一个接口502后，其它接口基本上也跟着502（首屏会发3个请求）。但是直接node服务器的IP+PORT访问，一切都是那么的完美！既然有问题了，开始查问题！</p>
<h2 id="fix-problem"><a href="#fix-problem" class="headerlink" title="fix problem"></a>fix problem</h2><p>&emsp;&emsp;接下来将以多个步骤，讲解fix的过程。</p>
<h3 id="Step-1-ops查ng日志"><a href="#Step-1-ops查ng日志" class="headerlink" title="Step.1 ops查ng日志"></a>Step.1 ops查ng日志</h3><p>&emsp;&emsp;首先ops贴了一份ng日志：<br><img src="/images/ng-4.png" alt="ng"><br>&emsp;&emsp;ops支持人员说：google了下   意思大概是说这部分访问进来走的是ng上处于半连接的tcp连接，__导致服务没处理就关闭连接了__。所以我们看到是502。我们可以先尝试__增加连接的超时时间__。</p>
<h3 id="Step-1-result"><a href="#Step-1-result" class="headerlink" title="Step.1_result"></a>Step.1_result</h3><p>&emsp;&emsp;增加了超时连接后，依然出现502。继续。</p>
<h3 id="Step-2-Nodejs服务端查日志"><a href="#Step-2-Nodejs服务端查日志" class="headerlink" title="Step.2 Nodejs服务端查日志"></a>Step.2 Nodejs服务端查日志</h3><p>&emsp;&emsp;作为大前端，查node日志肯定是我们基本功。守护程序使用的是pm2。但是我们却意外地发现，并没有__看到任何502的请求进来__！并且查看到当时的系统负载很低，不会因为负载大而断链。也就说是，ng返回给前端的502请求，__并没有进入到node服务器中__！这时候我们认为是ng转发有问题！联系ops继续看ng。</p>
<h3 id="Step-2-result"><a href="#Step-2-result" class="headerlink" title="Step.2_result"></a>Step.2_result</h3><p>&emsp;&emsp;失败，继续找ops定位问题。</p>
<h3 id="Step-3-ops修改到upstream为长连接"><a href="#Step-3-ops修改到upstream为长连接" class="headerlink" title="Step.3 ops修改到upstream为长连接"></a>Step.3 ops修改到upstream为长连接</h3><p>&emsp;&emsp;ops说，考虑到多种因素，一般连接到upstream都采用的是短链接，对于频繁访问的接口，可以尝试使用长连接。经过我们大前端的确认，node服务器支持HTTP1.1的长连接，开始实验。</p>
<h3 id="Step-3-result"><a href="#Step-3-result" class="headerlink" title="Step.3_result"></a>Step.3_result</h3><p>&emsp;&emsp;更为长连接后，502情况依然存在。失败。</p>
<h3 id="Step-4-查看node服务的超时处理"><a href="#Step-4-查看node服务的超时处理" class="headerlink" title="Step.4 查看node服务的超时处理"></a>Step.4 查看node服务的超时处理</h3><p>&emsp;&emsp;ops认为node服务在处理请求时，会有默认的超时处理。经过我们的确认，nodejs的http服务器默认超时时间是2min（我们并未手动更改超时时间），而出现502的情况是在请求发出后1秒内返回的。node服务器代码内，我们并未手动返回502状态（如果能手动返回502，那么说明请求已经到了node服务中间件，不可能出现没有请求日志的情况）。<br><img src="/images/ng-5.png" alt="ng"></p>
<h3 id="Step-4-result"><a href="#Step-4-result" class="headerlink" title="Step.4_result"></a>Step.4_result</h3><p>&emsp;&emsp;node服务器并没手动返回502状态码，准确地说应该是没走到业务逻辑中就已经挂了。</p>
<h3 id="Step-5-网络层面—抓包"><a href="#Step-5-网络层面—抓包" class="headerlink" title="Step.5 网络层面—抓包"></a>Step.5 网络层面—抓包</h3><p>&emsp;&emsp;现在的问题是，ops认为是node服务器有问题，我们认为是ng服务器有问题（确实各有各的道理），所以得找出是不是自身的问题。ops决定采用抓包的方式，看请求转发过程中请求、响应情况。下图是ops提供的ng服务器抓包图：<br><img src="/images/ng-6.png" alt="ng"><br>&emsp;&emsp;由上图可以看出，ng发出请求到upstream的服务端口（这里将简称D端口）后（就是当前hover的条目），D端口监听的程序（node服务器）没有给出相应，而是先回了个Ack，然后直接发起Fin，结束连接。ng也回复Fin，确定结束连接。对于Ng来说，upstream没有返回任何东西，连响应头也没有，就给前端返回502了。找到了问题，下面就看这种情况产生的原因及处理方案了。</p>
<h3 id="Step-6-两端各自的尝试"><a href="#Step-6-两端各自的尝试" class="headerlink" title="Step.6 两端各自的尝试"></a>Step.6 两端各自的尝试</h3><h4 id="前端方案–node"><a href="#前端方案–node" class="headerlink" title="前端方案–node"></a>前端方案–node</h4><p>&emsp;&emsp;查日志过程中发现了大量的乱码，如下图：</p>
<p><img src="/images/ng-7.png" alt="ng"><br>&emsp;&emsp;发现前端并未对非英文字符或其他特殊字符做encode。在encode之后，抓包后未发现乱码，同时也并未再产生502的情况。（此时我已经觉得是node的问题了）。我的猜想是：含有特殊字符（或者叫非法字符）的url请求，当到达node的http服务时，在最底层net层就挂了，以至于传不到业务层（表现上就是肉眼不可见的请求日志）。<br>&emsp;&emsp;为了验证猜想，我查了一下Node-http文档：http.Server有一个clientError事件回调（只看到这么一个跟Error有关的server级回调）。于是我写了一个基本的http服务，并发送了一个如下的请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.end(<span class="string">&#x27;你好\n&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.on(<span class="string">&#x27;clientError&#x27;</span>, <span class="function">(<span class="params">err, socket</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;clientError 事件回调&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    socket.end(<span class="string">&#x27;HTTP/1.1 400 Bad Request\r\n\r\n&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">8888</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;localhost:8888/api/hotel/detailrecommend?hotelName=7)�R�(fI7��) ┳ ┓┏ ┯ ┓┌ ┬ ┐╔ ╦ ╗╓ ╥ ╖╒ ╤&#x27;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这里只是模拟乱码的出现，不一定非是这些字符。然后node服务打出的日志：</p>
<p><img src="/images/ng-8.png" alt="ng"><br>&emsp;&emsp;确实是server层面的出错了。我们看看这个rawPacket是什么：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /api/hotel/detailrecommend?hotelName=7)�R�(fI7��) ┳ ┓┏ ┯ ┓┌ ┬ ┐╔ ╦ ╗╓ ╥ ╖╒ ╤ HTTP/1.1</span><br><span class="line">Host: localhost:8888</span><br><span class="line">User-Agent: curl/7.47.0</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这就是出错的请求头。<br>&emsp;&emsp;找到了问题所在，我们可以处理这个问题了：__对server添加clientError事件，打点记录错误请求信息，并将该socket以状态码400返回（给ng服务器）__，不处理这个事件的话，socket会hang住，然后由tcp层面自动关闭（这纯属我瞎逼逼的）。问了一下java的同学，说java中是会处理非法字符的，但node确实是没有处理，还是说留了个__clientError__让我们自己处理？黑人问号脸。。</p>
<h4 id="ops方案–ng"><a href="#ops方案–ng" class="headerlink" title="ops方案–ng"></a>ops方案–ng</h4><p>&emsp;&emsp;至于为什么node服务器未响应，导致用户请求的其它请求也502了？ops同学给了如下解释：nginx被动检查导致，过多的错误会让ng认为server下线了，于是在一个fail_timeout周期内的请求都被ng直接返回502码，不管该请求是不是非法请求。ops同学继续补充：让touch域名的配置尽快迁移到OpenResty。OpenResty没有这个问题，它针对每个请求都是独立的，只依赖healthcheck状态，而不会依赖上一次请求的成功与否。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;这一次的故障，让我和多个部门的同学一起定位问题。从前端到ng，从ng到node，从业务层面到网络底层，都有了更深的理解。错误不可怕，可怕的是找不到哪里错了。顺便记一下__ng+node__模式下的坑点：</p>
<ul>
<li>node处理中要对所有异常进行处理，不管是业务层的，还是底层的。如果一开始就监听了clientError事件，那么解决这个问题就更加显而易见。</li>
<li>ng处理请求失败要结合具体场景，而不是所有upstream都是一个通用的模板。</li>
</ul>
<p>&emsp;&emsp;同时也get到了新技能：</p>
<ul>
<li>服务器抓包中使用，tcpdump命令进行抓包，常用的：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -vv -nn host &lt;ng server ip&gt; -w ng-request.pcap</span><br></pre></td></tr></table></figure>
&emsp;&emsp;即可捕获所有ng 打过来的请求，并保存在ng-request.pcap文件中，拉到本地用wiresharp瞅一眼，就知道tcp层面上的网络交互情况。</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nodejs/" rel="tag"># nodejs</a>
              <a href="/tags/nginx/" rel="tag"># nginx</a>
              <a href="/tags/502/" rel="tag"># 502</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/03/07/linux%E5%85%A5%E9%97%A8%E5%91%BD%E4%BB%A4%E8%A1%8C/" rel="prev" title="linux入门命令行">
                  <i class="fa fa-chevron-left"></i> linux入门命令行
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/03/14/v11-10-nodejs%E5%AD%A6%E4%B9%A0-%E4%B8%89/" rel="next" title="v11-10-nodejs学习-三">
                  v11-10-nodejs学习-三 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81MjY5OS8yOTE3Ng=="></div><script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class=""></i>
  </span>
  <span class="author" itemprop="copyrightHolder">谭智轩</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  




<script src="/js/third-party/comments/livere.js"></script>

</body>
</html>
