<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;tzxhy.github.io&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12,&quot;b2t&quot;:false,&quot;scrollpercent&quot;:false,&quot;onmobile&quot;:false},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:false,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;slideDownIn&quot;,&quot;post_body&quot;:&quot;slideDownIn&quot;,&quot;coll_header&quot;:&quot;slideLeftIn&quot;,&quot;sidebar&quot;:&quot;slideUpIn&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;Searching...&quot;,&quot;empty&quot;:&quot;We didn&#39;t find any results for the search: ${query}&quot;,&quot;hits_time&quot;:&quot;${hits} results found in ${time} ms&quot;,&quot;hits&quot;:&quot;${hits} results found&quot;}}</script>
<meta name="description" content="背景在 flutter 中，UI开发是非常重要的一块。但作为一个应用，路由管理也是非常重要的。在 flutter 中，路由不仅仅是逻辑上的控制，也在显示上有作用。下面就一起学习一下 flutter 的路由相关（以大量代码为主）。">
<meta property="og:type" content="article">
<meta property="og:title" content="flutter 中路由详解">
<meta property="og:url" content="https://tzxhy.github.io/2019/10/27/flutter-%E4%B8%AD%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="CMeUp">
<meta property="og:description" content="背景在 flutter 中，UI开发是非常重要的一块。但作为一个应用，路由管理也是非常重要的。在 flutter 中，路由不仅仅是逻辑上的控制，也在显示上有作用。下面就一起学习一下 flutter 的路由相关（以大量代码为主）。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-10-26T22:13:48.000Z">
<meta property="article:modified_time" content="2021-05-24T09:30:32.409Z">
<meta property="article:author" content="谭智轩">
<meta property="article:tag" content="flutter-route">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://tzxhy.github.io/2019/10/27/flutter-%E4%B8%AD%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;en&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;https:&#x2F;&#x2F;tzxhy.github.io&#x2F;2019&#x2F;10&#x2F;27&#x2F;flutter-%E4%B8%AD%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3&#x2F;&quot;,&quot;path&quot;:&quot;2019&#x2F;10&#x2F;27&#x2F;flutter-中路由详解&#x2F;&quot;,&quot;title&quot;:&quot;flutter 中路由详解&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>flutter 中路由详解 | CMeUp</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">CMeUp</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录一些学习心得，QQ:1139723651.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%86%E8%A7%A3%E5%9F%BA%E7%A1%80"><span class="nav-number">2.</span> <span class="nav-text">了解基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Navigator"><span class="nav-number">2.1.</span> <span class="nav-text">Navigator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Navigator"><span class="nav-number">2.1.1.</span> <span class="nav-text">使用Navigator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B7%E5%90%8D%E8%B7%AF%E7%94%B1"><span class="nav-number">2.1.2.</span> <span class="nav-text">具名路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A5%E6%A0%88%E5%8F%AF%E4%BB%A5%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">2.1.3.</span> <span class="nav-text">入栈可以返回值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%B9%E5%87%BA%E5%B1%82%E8%B7%AF%E7%94%B1"><span class="nav-number">2.1.4.</span> <span class="nav-text">弹出层路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1"><span class="nav-number">2.1.5.</span> <span class="nav-text">自定义路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E8%B7%AF%E7%94%B1"><span class="nav-number">2.1.6.</span> <span class="nav-text">嵌套路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Navigator-%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.7.</span> <span class="nav-text">Navigator 代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="nav-number">2.2.</span> <span class="nav-text">路由相关类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Route"><span class="nav-number">2.2.1.</span> <span class="nav-text">Route</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OverlayRoute"><span class="nav-number">2.2.2.</span> <span class="nav-text">OverlayRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TransitionRoute"><span class="nav-number">2.2.3.</span> <span class="nav-text">TransitionRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LocalHostory"><span class="nav-number">2.2.4.</span> <span class="nav-text">LocalHostory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ModalRoute"><span class="nav-number">2.2.5.</span> <span class="nav-text">ModalRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PopupRoute"><span class="nav-number">2.2.6.</span> <span class="nav-text">PopupRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PageRoute"><span class="nav-number">2.2.7.</span> <span class="nav-text">PageRoute</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MaterialPageRoute"><span class="nav-number">2.2.8.</span> <span class="nav-text">MaterialPageRoute</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E8%B7%AF%E7%94%B1"><span class="nav-number">3.</span> <span class="nav-text">操作路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%B7%AF%E7%94%B1%E7%9B%B8%E5%85%B3%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">4.</span> <span class="nav-text">基于路由相关的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%B9%E5%B1%82"><span class="nav-number">4.1.</span> <span class="nav-text">弹层</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">谭智轩</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">81</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/tzxhy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tzxhy" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.cn/user/1820446984508072" title="掘金 → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;1820446984508072" rel="noopener" target="_blank">掘金</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.yuque.com/tanzhixuan-zebzs" title="语雀 → https:&#x2F;&#x2F;www.yuque.com&#x2F;tanzhixuan-zebzs" rel="noopener" target="_blank">语雀</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://tzxhy.github.io/2019/10/27/flutter-%E4%B8%AD%E8%B7%AF%E7%94%B1%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="谭智轩">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CMeUp">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          flutter 中路由详解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-26 22:13:48" itemprop="dateCreated datePublished" datetime="2019-10-26T22:13:48Z">2019-10-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/flutter/" itemprop="url" rel="index"><span itemprop="name">flutter</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在 flutter 中，UI开发是非常重要的一块。但作为一个应用，路由管理也是非常重要的。在 flutter 中，路由不仅仅是逻辑上的控制，也在显示上有作用。下面就一起学习一下 flutter 的路由相关（以大量代码为主）。</p>
<span id="more"></span>

<h2 id="了解基础"><a href="#了解基础" class="headerlink" title="了解基础"></a>了解基础</h2><h3 id="Navigator"><a href="#Navigator" class="headerlink" title="Navigator"></a>Navigator</h3><p>flutter 中的页面，都是以路由的形式展现的。每一个路由可以理解为一个页面（也可以是覆盖在当前页面上的弹层）。全屏路由，一般继承 PageRoute；弹层路由，一般继承 PopupRoute。flutter 中通过导航器 <code>Navigator</code> 控制路由的入栈、出栈等。常规的多页应用，也都是一层覆盖一层路由，最上面的路由就是我们能看到的界面。</p>
<h4 id="使用Navigator"><a href="#使用Navigator" class="headerlink" title="使用Navigator"></a>使用<code>Navigator</code></h4><p>最简单的方式是使用 <code>WidgetsApp</code>或者<code>MetarialApp</code>作为顶层组件，其内会使用到 <code>Navigator</code>。比如：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MaterialApp(home: MyAppHome()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>入栈一个新的页面：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(context, MaterialPageRoute&lt;<span class="keyword">void</span>&gt;(</span><br><span class="line">  builder: (BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;My Page&#x27;</span>)),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: FlatButton(</span><br><span class="line">          child: Text(<span class="string">&#x27;POP&#x27;</span>),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            Navigator.pop(context);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>每一个路由被设计为 WidgetBuilder 形式，是因为它的创建是与环境(context)相关的。</p>
<h4 id="具名路由"><a href="#具名路由" class="headerlink" title="具名路由"></a>具名路由</h4><p>与常规路由一样，它也支持具名路由，在创建 <code>MaterialApp</code> 时，可以传入<code>routers</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MaterialApp(</span><br><span class="line">    home: MyAppHome(), <span class="comment">// becomes the route named &#x27;/&#x27;</span></span><br><span class="line">    routes: &lt;<span class="built_in">String</span>, WidgetBuilder&gt; &#123;</span><br><span class="line">      <span class="string">&#x27;/a&#x27;</span>: (BuildContext context) =&gt; MyPage(title: <span class="string">&#x27;page A&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;/b&#x27;</span>: (BuildContext context) =&gt; MyPage(title: <span class="string">&#x27;page B&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;/c&#x27;</span>: (BuildContext context) =&gt; MyPage(title: <span class="string">&#x27;page C&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入栈页面</span></span><br><span class="line">Navigator.pushNamed(context, <span class="string">&#x27;/b&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="入栈可以返回值"><a href="#入栈可以返回值" class="headerlink" title="入栈可以返回值"></a>入栈可以返回值</h4><p>入栈，从表面来看，像是一个 void 操作，但实际上，它可以返回一个值。比如：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> value = <span class="keyword">await</span> Navigator.push(context, MaterialPageRoute&lt;<span class="built_in">bool</span>&gt;(</span><br><span class="line">  builder: (BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: GestureDetector(</span><br><span class="line">        child: Text(<span class="string">&#x27;OK&#x27;</span>),</span><br><span class="line">        onTap: () &#123; Navigator.pop(context, <span class="keyword">true</span>); &#125;</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>上面的代码完成了入栈一个 <code>PageRoute</code>，并等待它弹出。这个返回值有什么用呢？</p>
<ul>
<li>如果用户时点击<code>Text(&#39;ok&#39;)</code>来返回的，<code>value</code> 会是 <code>true</code></li>
<li>如果用户是点击物理返回键（安卓）或者 <code>AppBar</code>上的按钮等方式，<code>value</code> 会是 <code>null</code></li>
</ul>
<p>这可以让我们知道路由是怎么被弹出的。</p>
<h4 id="弹出层路由"><a href="#弹出层路由" class="headerlink" title="弹出层路由"></a>弹出层路由</h4><p>之前说了，路由并不一定是全屏覆盖的，这里说的弹出层路由，就属于非全屏路由。弹出层会使用透明色遮罩层来盖住全屏，阻止与前层路由的交互。有许多内置使用弹出层的地方，比如 showDialog，showMenu 等。</p>
<h4 id="自定义路由"><a href="#自定义路由" class="headerlink" title="自定义路由"></a>自定义路由</h4><p>你能自定义路由，就像 PopupRoute、ModalRoute、PageRoute 等一样，你能控制过渡效果，遮罩层颜色，或者其他任何方面。比如我就实现了能够与前层路由交互的弹层路由。</p>
<h4 id="嵌套路由"><a href="#嵌套路由" class="headerlink" title="嵌套路由"></a>嵌套路由</h4><p>iOS 应用程序采用选项卡式导航。每一个 tab 维护了自己的导航历史。因此，每一个 tab 有自己的<code>Navigator</code>，像是一种并行导航。除此之外，还有一种场景：即使是不同的 tab，但如果触发了全局的弹窗，比如一个警告框，它应该是相对于屏幕的，而不是当前 tab 的导航器。所以，除了各个 tab 的导航器，还需要一个根导航器，来包含所有 tab 导航器。这就形成了嵌套的路由。<br>可参考这个官方用例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flutter code sample for</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The following example demonstrates how a nested [Navigator] can be used to</span></span><br><span class="line"><span class="comment">// present a standalone user registration journey.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Even though this example uses two [Navigator]s to demonstrate nested</span></span><br><span class="line"><span class="comment">// [Navigator]s, a similar result is possible using only a single [Navigator].</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Run this example with `flutter run --route=/signup` to start it with</span></span><br><span class="line"><span class="comment">// the signup flow instead of on the home page.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Code Sample for Navigator&#x27;</span>,</span><br><span class="line">      <span class="comment">// MaterialApp contains our top-level Navigator</span></span><br><span class="line">      initialRoute: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      routes: &#123;</span><br><span class="line">        <span class="string">&#x27;/&#x27;</span>: (BuildContext context) =&gt; HomePage(),</span><br><span class="line">        <span class="string">&#x27;/signup&#x27;</span>: (BuildContext context) =&gt; SignUpPage(),</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> DefaultTextStyle(</span><br><span class="line">      style: Theme.of(context).textTheme.display1,</span><br><span class="line">      child: Container(</span><br><span class="line">        color: Colors.white,</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        child: Text(<span class="string">&#x27;Home Page&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CollectPersonalInfoPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> DefaultTextStyle(</span><br><span class="line">      style: Theme.of(context).textTheme.display1,</span><br><span class="line">      child: GestureDetector(</span><br><span class="line">        onTap: () &#123;</span><br><span class="line">          <span class="comment">// This moves from the personal info page to the credentials page,</span></span><br><span class="line">          <span class="comment">// replacing this page with that one.</span></span><br><span class="line">          Navigator.of(context)</span><br><span class="line">              .pushReplacementNamed(<span class="string">&#x27;signup/choose_credentials&#x27;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Container(</span><br><span class="line">          color: Colors.lightBlue,</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          child: Text(<span class="string">&#x27;Collect Personal Info Page&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChooseCredentialsPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ChooseCredentialsPage(&#123;</span><br><span class="line">    <span class="keyword">this</span>.onSignupComplete,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> VoidCallback onSignupComplete;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GestureDetector(</span><br><span class="line">      onTap: onSignupComplete,</span><br><span class="line">      child: DefaultTextStyle(</span><br><span class="line">        style: Theme.of(context).textTheme.display1,</span><br><span class="line">        child: Container(</span><br><span class="line">          color: Colors.pinkAccent,</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          child: Text(<span class="string">&#x27;Choose Credentials Page&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SignUpPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// SignUpPage builds its own Navigator which ends up being a nested</span></span><br><span class="line">    <span class="comment">// Navigator in our app.</span></span><br><span class="line">    <span class="keyword">return</span> Navigator(</span><br><span class="line">      initialRoute: <span class="string">&#x27;signup/personal_info&#x27;</span>,</span><br><span class="line">      onGenerateRoute: (RouteSettings settings) &#123;</span><br><span class="line">        WidgetBuilder builder;</span><br><span class="line">        <span class="keyword">switch</span> (settings.name) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;signup/personal_info&#x27;</span>:</span><br><span class="line">            <span class="comment">// Assume CollectPersonalInfoPage collects personal info and then</span></span><br><span class="line">            <span class="comment">// navigates to &#x27;signup/choose_credentials&#x27;.</span></span><br><span class="line">            builder = (BuildContext _) =&gt; CollectPersonalInfoPage();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;signup/choose_credentials&#x27;</span>:</span><br><span class="line">            <span class="comment">// Assume ChooseCredentialsPage collects new credentials and then</span></span><br><span class="line">            <span class="comment">// invokes &#x27;onSignupComplete()&#x27;.</span></span><br><span class="line">            builder = (BuildContext _) =&gt; ChooseCredentialsPage(</span><br><span class="line">                  onSignupComplete: () &#123;</span><br><span class="line">                    <span class="comment">// Referencing Navigator.of(context) from here refers to the</span></span><br><span class="line">                    <span class="comment">// top level Navigator because SignUpPage is above the</span></span><br><span class="line">                    <span class="comment">// nested Navigator that it created. Therefore, this pop()</span></span><br><span class="line">                    <span class="comment">// will pop the entire &quot;sign up&quot; journey and return to the</span></span><br><span class="line">                    <span class="comment">// &quot;/&quot; route, AKA HomePage.</span></span><br><span class="line">                    Navigator.of(context).pop();</span><br><span class="line">                  &#125;,</span><br><span class="line">                );</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> Exception(<span class="string">&#x27;Invalid route: <span class="subst">$&#123;settings.name&#125;</span>&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MaterialPageRoute(builder: builder, settings: settings);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Navigator-代码"><a href="#Navigator-代码" class="headerlink" title="Navigator 代码"></a>Navigator 代码</h4><p>现在来看一下<code>Navigator</code>的代码。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Navigator</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Navigator(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="keyword">this</span>.initialRoute,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.onGenerateRoute,</span><br><span class="line">    <span class="keyword">this</span>.onUnknownRoute,</span><br><span class="line">    <span class="keyword">this</span>.observers = <span class="keyword">const</span> &lt;NavigatorObserver&gt;[],</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认需要显示的路由的路由名称</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> initialRoute;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当需要创建路由时的回调。签名如下：</span></span><br><span class="line">  <span class="comment">// typedef RouteFactory = Route&lt;dynamic&gt; Function(RouteSettings settings);</span></span><br><span class="line">  <span class="keyword">final</span> RouteFactory onGenerateRoute;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当`onGenerateRoute`没有返回 route 时的回调。一般用于错误处理。</span></span><br><span class="line">  <span class="keyword">final</span> RouteFactory onUnknownRoute;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 导航器的监听对象列表</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;NavigatorObserver&gt; observers;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> defaultRouteName = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入栈一个具名路由</span></span><br><span class="line">  <span class="comment">// 新路由和先前的路由会被通知。如果有监听者对象，同样也会触发。</span></span><br><span class="line">  <span class="comment">// 如果新路由入栈，此时在当前路由中持续的手势会被取消（WTF?）</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; pushNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">   &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pushNamed&lt;T&gt;(routeName, arguments: arguments);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换当前路由。在新路由完成入栈后，移除原来的路由。</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; pushReplacementNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    TO result,</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pushReplacementNamed&lt;T, TO&gt;(routeName, arguments: arguments, result: result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除当前路由，再入栈新的路由。</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; popAndPushNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    TO result,</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">   &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).popAndPushNamed&lt;T, TO&gt;(routeName, arguments: arguments, result: result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 先入栈新路由，再一直移除路由。</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; pushNamedAndRemoveUntil&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    <span class="built_in">String</span> newRouteName,</span><br><span class="line">    RoutePredicate predicate, &#123;</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pushNamedAndRemoveUntil&lt;T&gt;(newRouteName, predicate, arguments: arguments);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入栈一个路由</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; push&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, Route&lt;T&gt; route) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).push(route);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入栈一个路由，结束后移除之前的路由</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; pushReplacement&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, Route&lt;T&gt; newRoute, &#123; TO result &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pushReplacement&lt;T, TO&gt;(newRoute, result: result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 已有相关解释</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;T&gt; pushAndRemoveUntil&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, Route&lt;T&gt; newRoute, RoutePredicate predicate) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pushAndRemoveUntil&lt;T&gt;(newRoute, predicate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换当前路由</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> replace&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, &#123; <span class="meta">@required</span> Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute, <span class="meta">@required</span> Route&lt;T&gt; newRoute &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).replace&lt;T&gt;(oldRoute: oldRoute, newRoute: newRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换给定锚点路由下的路由</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> replaceRouteBelow&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, &#123; <span class="meta">@required</span> Route&lt;<span class="built_in">dynamic</span>&gt; anchorRoute, Route&lt;T&gt; newRoute &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).replaceRouteBelow&lt;T&gt;(anchorRoute: anchorRoute, newRoute: newRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 能否 pop</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">bool</span> canPop(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> NavigatorState navigator = Navigator.of(context, nullOk: <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> navigator != <span class="keyword">null</span> &amp;&amp; navigator.canPop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 Route.willPop 来判断是否弹出。</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;<span class="built_in">bool</span>&gt; maybePop&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, [ T result ]) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).maybePop&lt;T&gt;(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 弹出</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">bool</span> pop&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, [ T result ]) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).pop&lt;T&gt;(result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 弹出直到</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> popUntil(BuildContext context, RoutePredicate predicate) &#123;</span><br><span class="line">    Navigator.of(context).popUntil(predicate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除给定 route</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> removeRoute(BuildContext context, Route&lt;<span class="built_in">dynamic</span>&gt; route) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).removeRoute(route);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除锚点后的 route</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> removeRouteBelow(BuildContext context, Route&lt;<span class="built_in">dynamic</span>&gt; anchorRoute) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).removeRouteBelow(anchorRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">static</span> NavigatorState of(</span><br><span class="line">    BuildContext context, &#123;</span><br><span class="line">    <span class="built_in">bool</span> rootNavigator = <span class="keyword">false</span>,</span><br><span class="line">    <span class="built_in">bool</span> nullOk = <span class="keyword">false</span>,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> NavigatorState navigator = rootNavigator</span><br><span class="line">        ? context.rootAncestorStateOfType(<span class="keyword">const</span> TypeMatcher&lt;NavigatorState&gt;())</span><br><span class="line">        : context.ancestorStateOfType(<span class="keyword">const</span> TypeMatcher&lt;NavigatorState&gt;());</span><br><span class="line">    <span class="keyword">return</span> navigator;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  NavigatorState createState() =&gt; NavigatorState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实看完了，大概就一些常用的路由操作。静态方法 of 中有一个 <code>rootNavigator</code> 用于决定是否使用最远端的导航器。再单导航器中 true or false 都无所谓。主要逻辑都在 <code>NavigatorState</code>中。来看一下 <code>NavigatorState</code>。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NavigatorState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Navigator</span>&gt; <span class="title">with</span> <span class="title">TickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// overlay key</span></span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;OverlayState&gt; _overlayKey = GlobalKey&lt;OverlayState&gt;();</span><br><span class="line">  <span class="comment">// 当前导航器历史的 list</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt; _history = &lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt;[];</span><br><span class="line">  <span class="comment">// 移除了的路由，以 Set 保存。</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Set</span>&lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt; _poppedRoutes = &lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">The [FocusScopeNode] for the [FocusScope] that encloses the routes.</span></span></span><br><span class="line">  <span class="keyword">final</span> FocusScopeNode focusScopeNode = FocusScopeNode(debugLabel: <span class="string">&#x27;Navigator Scope&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; _initialOverlayEntries = &lt;OverlayEntry&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers) &#123;</span><br><span class="line">      observer._navigator = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">String</span> initialRouteName = widget.initialRoute ?? Navigator.defaultRouteName;</span><br><span class="line">    <span class="keyword">if</span> (initialRouteName.startsWith(<span class="string">&#x27;/&#x27;</span>) &amp;&amp; initialRouteName.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      initialRouteName = initialRouteName.substring(<span class="number">1</span>); <span class="comment">// strip leading &#x27;/&#x27;</span></span><br><span class="line">      <span class="keyword">assert</span>(Navigator.defaultRouteName == <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; plannedInitialRouteNames = &lt;<span class="built_in">String</span>&gt;[</span><br><span class="line">        Navigator.defaultRouteName,</span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">List</span>&lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt; plannedInitialRoutes = &lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt;[</span><br><span class="line">        _routeNamed&lt;<span class="built_in">dynamic</span>&gt;(Navigator.defaultRouteName, allowNull: <span class="keyword">true</span>, arguments: <span class="keyword">null</span>),</span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; routeParts = initialRouteName.split(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (initialRouteName.isNotEmpty) &#123;</span><br><span class="line">        <span class="built_in">String</span> routeName = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">String</span> <span class="keyword">part</span> <span class="keyword">in</span> routeParts) &#123;</span><br><span class="line">          routeName += <span class="string">&#x27;/<span class="subst">$part</span>&#x27;</span>;</span><br><span class="line">          plannedInitialRouteNames.add(routeName);</span><br><span class="line">          plannedInitialRoutes.add(_routeNamed&lt;<span class="built_in">dynamic</span>&gt;(routeName, allowNull: <span class="keyword">true</span>, arguments: <span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (plannedInitialRoutes.contains(<span class="keyword">null</span>)) &#123;</span><br><span class="line">        push(_routeNamed&lt;<span class="built_in">Object</span>&gt;(Navigator.defaultRouteName, arguments: <span class="keyword">null</span>));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        plannedInitialRoutes.forEach(push);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Route&lt;<span class="built_in">Object</span>&gt; route;</span><br><span class="line">      <span class="keyword">if</span> (initialRouteName != Navigator.defaultRouteName)</span><br><span class="line">        route = _routeNamed&lt;<span class="built_in">Object</span>&gt;(initialRouteName, allowNull: <span class="keyword">true</span>, arguments: <span class="keyword">null</span>);</span><br><span class="line">      route ??= _routeNamed&lt;<span class="built_in">Object</span>&gt;(Navigator.defaultRouteName, arguments: <span class="keyword">null</span>);</span><br><span class="line">      push(route);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Route&lt;<span class="built_in">dynamic</span>&gt; route <span class="keyword">in</span> _history)</span><br><span class="line">      _initialOverlayEntries.addAll(route.overlayEntries);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didUpdateWidget(Navigator oldWidget) &#123;</span><br><span class="line">    <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">    <span class="keyword">if</span> (oldWidget.observers != widget.observers) &#123;</span><br><span class="line">      <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> oldWidget.observers)</span><br><span class="line">        observer._navigator = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers) &#123;</span><br><span class="line">        observer._navigator = <span class="keyword">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Route&lt;<span class="built_in">dynamic</span>&gt; route <span class="keyword">in</span> _history)</span><br><span class="line">      route.changedExternalState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回收：</span></span><br><span class="line">  <span class="comment">//   1. 监听器的_navigator 属性置空</span></span><br><span class="line">  <span class="comment">//   2. 每一个路由调用 dispose，并清空弹出历史、当前历史</span></span><br><span class="line">  <span class="comment">//   3. 失焦</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer._navigator = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt; doomed = _poppedRoutes.toList()..addAll(_history);</span><br><span class="line">    <span class="keyword">for</span> (Route&lt;<span class="built_in">dynamic</span>&gt; route <span class="keyword">in</span> doomed)</span><br><span class="line">      route.dispose();</span><br><span class="line">    _poppedRoutes.clear();</span><br><span class="line">    _history.clear();</span><br><span class="line">    focusScopeNode.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">当前导航器用于展示内容的覆盖层</span></span></span><br><span class="line">  OverlayState <span class="keyword">get</span> overlay =&gt; _overlayKey.currentState;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回当前导航器最上层覆盖层的最上层</span></span><br><span class="line">  OverlayEntry <span class="keyword">get</span> _currentOverlayEntry &#123;</span><br><span class="line">    <span class="keyword">for</span> (Route&lt;<span class="built_in">dynamic</span>&gt; route <span class="keyword">in</span> _history.reversed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (route.overlayEntries.isNotEmpty)</span><br><span class="line">        <span class="keyword">return</span> route.overlayEntries.last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> _debugLocked = <span class="keyword">false</span>; <span class="comment">// used to prevent re-entrant calls to push, pop, and friends</span></span><br><span class="line"></span><br><span class="line">  Route&lt;T&gt; _routeNamed&lt;T&gt;(<span class="built_in">String</span> name, &#123; <span class="meta">@required</span> <span class="built_in">Object</span> arguments, <span class="built_in">bool</span> allowNull = <span class="keyword">false</span> &#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> RouteSettings settings = RouteSettings(</span><br><span class="line">      name: name,</span><br><span class="line">      isInitialRoute: _history.isEmpty,</span><br><span class="line">      arguments: arguments,</span><br><span class="line">    );</span><br><span class="line">    Route&lt;T&gt; route = widget.onGenerateRoute(settings);</span><br><span class="line">    <span class="keyword">if</span> (route == <span class="keyword">null</span> &amp;&amp; !allowNull) &#123;</span><br><span class="line">      route = widget.onUnknownRoute(settings);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> route;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; pushNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> push&lt;T&gt;(_routeNamed&lt;T&gt;(routeName, arguments: arguments));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; pushReplacementNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    TO result,</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> pushReplacement&lt;T, TO&gt;(_routeNamed&lt;T&gt;(routeName, arguments: arguments), result: result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; popAndPushNamed&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    <span class="built_in">String</span> routeName, &#123;</span><br><span class="line">    TO result,</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    pop&lt;TO&gt;(result);</span><br><span class="line">    <span class="keyword">return</span> pushNamed&lt;T&gt;(routeName, arguments: arguments);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; pushNamedAndRemoveUntil&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(</span><br><span class="line">    <span class="built_in">String</span> newRouteName,</span><br><span class="line">    RoutePredicate predicate, &#123;</span><br><span class="line">    <span class="built_in">Object</span> arguments,</span><br><span class="line">  &#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> pushAndRemoveUntil&lt;T&gt;(_routeNamed&lt;T&gt;(newRouteName, arguments: arguments), predicate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 入栈路由关键方法</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; push&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(Route&lt;T&gt; route) &#123;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute = _history.isNotEmpty ? _history.last : <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 设置新路由的导航器</span></span><br><span class="line">    route._navigator = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// 安装路由. 一般是讲 overlay 插入到 overlayEntry</span></span><br><span class="line">    route.install(_currentOverlayEntry);</span><br><span class="line">    <span class="comment">// 当前历史添加该路由</span></span><br><span class="line">    _history.add(route);</span><br><span class="line">    <span class="comment">// 该路由触发 didPush</span></span><br><span class="line">    route.didPush();</span><br><span class="line">    <span class="comment">// 该路由触发 didChangeNext 参数为 null</span></span><br><span class="line">    route.didChangeNext(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (oldRoute != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 触发上一个路由的 didChangeNext,参数为新路由</span></span><br><span class="line">      oldRoute.didChangeNext(route);</span><br><span class="line">      <span class="comment">// 新路由触发 didChangePrevious 参数为 老路由</span></span><br><span class="line">      route.didChangePrevious(oldRoute);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 触发监听器</span></span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer.didPush(route, oldRoute);</span><br><span class="line">    <span class="comment">// 这个方法当前只针对了 web 有操作</span></span><br><span class="line">    RouteNotificationMessages.maybeNotifyRouteChange(_routePushedMethod, route, oldRoute);</span><br><span class="line">    <span class="comment">// 在导航后的其他操作. 比如取消老路由中的所有手势...</span></span><br><span class="line">    _afterNavigation(route);</span><br><span class="line">    <span class="keyword">return</span> route.popped;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _afterNavigation&lt;T&gt;(Route&lt;T&gt; route) &#123;</span><br><span class="line">    _cancelActivePointers();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; pushReplacement&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>, TO <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(Route&lt;T&gt; newRoute, &#123; TO result &#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute = _history.last;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> index = _history.length - <span class="number">1</span>;</span><br><span class="line">    newRoute._navigator = <span class="keyword">this</span>;</span><br><span class="line">    newRoute.install(_currentOverlayEntry);</span><br><span class="line">    _history[index] = newRoute;</span><br><span class="line">    newRoute.didPush().whenCompleteOrCancel(() &#123;</span><br><span class="line">      <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">        oldRoute</span><br><span class="line">          ..didComplete(result ?? oldRoute.currentResult)</span><br><span class="line">          ..dispose();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    newRoute.didChangeNext(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      _history[index - <span class="number">1</span>].didChangeNext(newRoute);</span><br><span class="line">      newRoute.didChangePrevious(_history[index - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer.didReplace(newRoute: newRoute, oldRoute: oldRoute);</span><br><span class="line">    RouteNotificationMessages.maybeNotifyRouteChange(_routeReplacedMethod, newRoute, oldRoute);</span><br><span class="line">    _afterNavigation(newRoute);</span><br><span class="line">    <span class="keyword">return</span> newRoute.popped;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;T&gt; pushAndRemoveUntil&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(Route&lt;T&gt; newRoute, RoutePredicate predicate) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// The route that is being pushed on top of</span></span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; precedingRoute = _history.isNotEmpty ? _history.last : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> OverlayEntry precedingRouteOverlay = _currentOverlayEntry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Routes to remove</span></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt; removedRoutes = &lt;Route&lt;<span class="built_in">dynamic</span>&gt;&gt;[];</span><br><span class="line">    <span class="keyword">while</span> (_history.isNotEmpty &amp;&amp; !predicate(_history.last)) &#123;</span><br><span class="line">      <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; removedRoute = _history.removeLast();</span><br><span class="line">      removedRoutes.add(removedRoute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Push new route</span></span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; newPrecedingRoute = _history.isNotEmpty ? _history.last : <span class="keyword">null</span>;</span><br><span class="line">    newRoute._navigator = <span class="keyword">this</span>;</span><br><span class="line">    newRoute.install(precedingRouteOverlay);</span><br><span class="line">    _history.add(newRoute);</span><br><span class="line"></span><br><span class="line">    newRoute.didPush().whenCompleteOrCancel(() &#123;</span><br><span class="line">      <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Route&lt;<span class="built_in">dynamic</span>&gt; removedRoute <span class="keyword">in</span> removedRoutes) &#123;</span><br><span class="line">          <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">            observer.didRemove(removedRoute, newPrecedingRoute);</span><br><span class="line">          removedRoute.dispose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newPrecedingRoute != <span class="keyword">null</span>)</span><br><span class="line">          newPrecedingRoute.didChangeNext(newRoute);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify for newRoute</span></span><br><span class="line">    newRoute.didChangeNext(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer.didPush(newRoute, precedingRoute);</span><br><span class="line">    _afterNavigation(newRoute);</span><br><span class="line">    <span class="keyword">return</span> newRoute.popped;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">void</span> replace&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(&#123; <span class="meta">@required</span> Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute, <span class="meta">@required</span> Route&lt;T&gt; newRoute &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldRoute == newRoute)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> index = _history.indexOf(oldRoute);</span><br><span class="line">    newRoute._navigator = <span class="keyword">this</span>;</span><br><span class="line">    newRoute.install(oldRoute.overlayEntries.last);</span><br><span class="line">    _history[index] = newRoute;</span><br><span class="line">    newRoute.didReplace(oldRoute);</span><br><span class="line">    <span class="keyword">if</span> (index + <span class="number">1</span> &lt; _history.length) &#123;</span><br><span class="line">      newRoute.didChangeNext(_history[index + <span class="number">1</span>]);</span><br><span class="line">      _history[index + <span class="number">1</span>].didChangePrevious(newRoute);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newRoute.didChangeNext(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      _history[index - <span class="number">1</span>].didChangeNext(newRoute);</span><br><span class="line">      newRoute.didChangePrevious(_history[index - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer.didReplace(newRoute: newRoute, oldRoute: oldRoute);</span><br><span class="line">    RouteNotificationMessages.maybeNotifyRouteChange(_routeReplacedMethod, newRoute, oldRoute);</span><br><span class="line">    oldRoute.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">void</span> replaceRouteBelow&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(&#123; <span class="meta">@required</span> Route&lt;<span class="built_in">dynamic</span>&gt; anchorRoute, Route&lt;T&gt; newRoute &#125;) &#123;</span><br><span class="line">    replace&lt;T&gt;(oldRoute: _history[_history.indexOf(anchorRoute) - <span class="number">1</span>], newRoute: newRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> canPop() &#123;</span><br><span class="line">    <span class="keyword">return</span> _history.length &gt; <span class="number">1</span> || _history[<span class="number">0</span>].willHandlePopInternally;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 route.willPop 来判断 是否可以弹出</span></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; maybePop&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;([ T result ]) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;T&gt; route = _history.last;</span><br><span class="line">    <span class="keyword">final</span> RoutePopDisposition disposition = <span class="keyword">await</span> route.willPop();</span><br><span class="line">    <span class="keyword">if</span> (disposition != RoutePopDisposition.bubble &amp;&amp; mounted) &#123;</span><br><span class="line">      <span class="keyword">if</span> (disposition == RoutePopDisposition.pop)</span><br><span class="line">        pop(result);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="built_in">bool</span> pop&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;([ T result ]) &#123;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; route = _history.last;</span><br><span class="line">    <span class="built_in">bool</span> debugPredictedWouldPop;</span><br><span class="line">    <span class="keyword">if</span> (route.didPop(result ?? route.currentResult)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (_history.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        _history.removeLast();</span><br><span class="line">        <span class="keyword">if</span> (route._navigator != <span class="keyword">null</span>)</span><br><span class="line">          _poppedRoutes.add(route);</span><br><span class="line">        _history.last.didPopNext(route);</span><br><span class="line">        <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">          observer.didPop(route, _history.last);</span><br><span class="line">        RouteNotificationMessages.maybeNotifyRouteChange(_routePoppedMethod, route, _history.last);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    _afterNavigation&lt;<span class="built_in">dynamic</span>&gt;(route);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> popUntil(RoutePredicate predicate) &#123;</span><br><span class="line">    <span class="keyword">while</span> (!predicate(_history.last))</span><br><span class="line">      pop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> removeRoute(Route&lt;<span class="built_in">dynamic</span>&gt; route) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> index = _history.indexOf(route);</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; previousRoute = index &gt; <span class="number">0</span> ? _history[index - <span class="number">1</span>] : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute = (index + <span class="number">1</span> &lt; _history.length) ? _history[index + <span class="number">1</span>] : <span class="keyword">null</span>;</span><br><span class="line">    _history.removeAt(index);</span><br><span class="line">    previousRoute?.didChangeNext(nextRoute);</span><br><span class="line">    nextRoute?.didChangePrevious(previousRoute);</span><br><span class="line">    <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">      observer.didRemove(route, previousRoute);</span><br><span class="line">    route.dispose();</span><br><span class="line">    _afterNavigation&lt;<span class="built_in">dynamic</span>&gt;(nextRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> removeRouteBelow(Route&lt;<span class="built_in">dynamic</span>&gt; anchorRoute) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> index = _history.indexOf(anchorRoute) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; targetRoute = _history[index];</span><br><span class="line">    _history.removeAt(index);</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute = index &lt; _history.length ? _history[index] : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; previousRoute = index &gt; <span class="number">0</span> ? _history[index - <span class="number">1</span>] : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (previousRoute != <span class="keyword">null</span>)</span><br><span class="line">      previousRoute.didChangeNext(nextRoute);</span><br><span class="line">    <span class="keyword">if</span> (nextRoute != <span class="keyword">null</span>)</span><br><span class="line">      nextRoute.didChangePrevious(previousRoute);</span><br><span class="line">    targetRoute.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> finalizeRoute(Route&lt;<span class="built_in">dynamic</span>&gt; route) &#123;</span><br><span class="line">    _poppedRoutes.remove(route);</span><br><span class="line">    route.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前路由是否用户正在操作</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> userGestureInProgress =&gt; _userGesturesInProgress &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">int</span> _userGesturesInProgress = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户开始操作的回调</span></span><br><span class="line">  <span class="keyword">void</span> didStartUserGesture() &#123;</span><br><span class="line">    _userGesturesInProgress += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_userGesturesInProgress == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; route = _history.last;</span><br><span class="line">      <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; previousRoute = !route.willHandlePopInternally &amp;&amp; _history.length &gt; <span class="number">1</span></span><br><span class="line">          ? _history[_history.length - <span class="number">2</span>]</span><br><span class="line">          : <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">        observer.didStartUserGesture(route, previousRoute);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用户完成操作的回调</span></span><br><span class="line">  <span class="keyword">void</span> didStopUserGesture() &#123;</span><br><span class="line">    _userGesturesInProgress -= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_userGesturesInProgress == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">        observer.didStopUserGesture();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 活跃的指针, 指手势?</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Set</span>&lt;<span class="built_in">int</span>&gt; _activePointers = &lt;<span class="built_in">int</span>&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _handlePointerDown(PointerDownEvent event) &#123;</span><br><span class="line">    _activePointers.add(event.pointer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _handlePointerUpOrCancel(PointerEvent event) &#123;</span><br><span class="line">    _activePointers.remove(event.pointer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 取消所有活跃手势</span></span><br><span class="line">  <span class="keyword">void</span> _cancelActivePointers() &#123;</span><br><span class="line">    <span class="keyword">if</span> (SchedulerBinding.instance.schedulerPhase == SchedulerPhase.idle) &#123;</span><br><span class="line">      <span class="keyword">final</span> RenderAbsorbPointer absorber = _overlayKey.currentContext?.ancestorRenderObjectOfType(<span class="keyword">const</span> TypeMatcher&lt;RenderAbsorbPointer&gt;());</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        absorber?.absorbing = <span class="keyword">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    _activePointers.toList().forEach(WidgetsBinding.instance.cancelPointer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Listener(</span><br><span class="line">      onPointerDown: _handlePointerDown,</span><br><span class="line">      onPointerUp: _handlePointerUpOrCancel,</span><br><span class="line">      onPointerCancel: _handlePointerUpOrCancel,</span><br><span class="line">      child: AbsorbPointer(</span><br><span class="line">        absorbing: <span class="keyword">false</span>, <span class="comment">// it&#x27;s mutated directly by _cancelActivePointers above</span></span><br><span class="line">        child: FocusScope(</span><br><span class="line">          node: focusScopeNode,</span><br><span class="line">          autofocus: <span class="keyword">true</span>,</span><br><span class="line">          child: Overlay(</span><br><span class="line">            key: _overlayKey,</span><br><span class="line">            initialEntries: _initialOverlayEntries,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看完了这个 State, 其实也没啥. 主要就是一些常规的路由操作. 比较有意思的事, 在入栈路由时, 会取消前路由的所有事件(有个 issue, 大家有兴趣的可以看看). 前面也提到了 <code>Overlay</code> 和 <code>Focus</code>, 下面来看看这个.</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于放入 Overlay中的, 可以包含组件.</span></span><br><span class="line"><span class="comment">// 一个OverlayEntry 同时最多只能被一个 Overlay 拥有.</span></span><br><span class="line"><span class="comment">// 因为 Overlay 使用 Stack 布局, 所以 OverlayEntry 可以使用 [Positioned] 和 </span></span><br><span class="line"><span class="comment">// [AnimatedPositioned]来定位.</span></span><br><span class="line"><span class="comment">// 默认情况下, 如果有一个完全不透明的层在这层之上, 那么这一层就不会进行 build. 除非设置 [maintainState]</span></span><br><span class="line"><span class="comment">// 为 true. (这可能会引起性能问题, 慎用)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OverlayEntry</span> </span>&#123;</span><br><span class="line">  OverlayEntry(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">    <span class="built_in">bool</span> opaque = <span class="keyword">false</span>,</span><br><span class="line">    <span class="built_in">bool</span> maintainState = <span class="keyword">false</span>,</span><br><span class="line">  &#125;) : _opaque = opaque,</span><br><span class="line">       _maintainState = maintainState;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> WidgetBuilder builder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果该层设置为遮挡, 则该层以下的层默认不会被 build, 除非</span></span><br><span class="line">  <span class="comment">// 设置了 [maintainState] 为 true</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> opaque =&gt; _opaque;</span><br><span class="line">  <span class="built_in">bool</span> _opaque;</span><br><span class="line">  <span class="keyword">set</span> opaque(<span class="built_in">bool</span> value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_opaque == value)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    _opaque = value;</span><br><span class="line">    _overlay._didChangeEntryOpacity();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> maintainState =&gt; _maintainState;</span><br><span class="line">  <span class="built_in">bool</span> _maintainState;</span><br><span class="line">  <span class="keyword">set</span> maintainState(<span class="built_in">bool</span> value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_maintainState == value)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    _maintainState = value;</span><br><span class="line">    _overlay._didChangeEntryOpacity();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 Overlay 中设置</span></span><br><span class="line">  OverlayState _overlay;</span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;_OverlayEntryState&gt; _key = GlobalKey&lt;_OverlayEntryState&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> remove() &#123; </span><br><span class="line">    <span class="keyword">final</span> OverlayState overlay = _overlay;</span><br><span class="line">    _overlay = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (SchedulerBinding.instance.schedulerPhase == SchedulerPhase.persistentCallbacks) &#123;</span><br><span class="line">      SchedulerBinding.instance.addPostFrameCallback((<span class="built_in">Duration</span> duration) &#123;</span><br><span class="line">        overlay._remove(<span class="keyword">this</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      overlay._remove(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> markNeedsBuild() &#123;</span><br><span class="line">    _key.currentState?._markNeedsBuild();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_OverlayEntry</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  _OverlayEntry(<span class="keyword">this</span>.entry)</span><br><span class="line">    : <span class="keyword">super</span>(key: entry._key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> OverlayEntry entry;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _OverlayEntryState createState() =&gt; _OverlayEntryState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_OverlayEntryState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">_OverlayEntry</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> widget.entry.builder(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _markNeedsBuild() &#123;</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Overlay</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> Overlay(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="keyword">this</span>.initialEntries = <span class="keyword">const</span> &lt;OverlayEntry&gt;[],</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; initialEntries;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> OverlayState of(BuildContext context, &#123; Widget debugRequiredFor &#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> OverlayState result = context.ancestorStateOfType(<span class="keyword">const</span> TypeMatcher&lt;OverlayState&gt;());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  OverlayState createState() =&gt; OverlayState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OverlayState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Overlay</span>&gt; <span class="title">with</span> <span class="title">TickerProviderStateMixin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; _entries = &lt;OverlayEntry&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    insertAll(widget.initialEntries);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> _insertionIndex(OverlayEntry below, OverlayEntry above) &#123;</span><br><span class="line">    <span class="keyword">if</span> (below != <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span> _entries.indexOf(below);</span><br><span class="line">    <span class="keyword">if</span> (above != <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">return</span> _entries.indexOf(above) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> _entries.length;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> insert(OverlayEntry entry, &#123; OverlayEntry below, OverlayEntry above &#125;) &#123;</span><br><span class="line">    entry._overlay = <span class="keyword">this</span>;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _entries.insert(_insertionIndex(below, above), entry);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> insertAll(<span class="built_in">Iterable</span>&lt;OverlayEntry&gt; entries, &#123; OverlayEntry below, OverlayEntry above &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entries.isEmpty)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">for</span> (OverlayEntry entry <span class="keyword">in</span> entries) &#123;</span><br><span class="line">      entry._overlay = <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _entries.insertAll(_insertionIndex(below, above), entries);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重新排放</span></span><br><span class="line">  <span class="keyword">void</span> rearrange(<span class="built_in">Iterable</span>&lt;OverlayEntry&gt; newEntries, &#123; OverlayEntry below, OverlayEntry above &#125;) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; newEntriesList = newEntries <span class="keyword">is</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; ? newEntries : newEntries.toList(growable: <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (newEntriesList.isEmpty)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (listEquals(_entries, newEntriesList))</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">final</span> LinkedHashSet&lt;OverlayEntry&gt; old = LinkedHashSet&lt;OverlayEntry&gt;.from(_entries);</span><br><span class="line">    <span class="keyword">for</span> (OverlayEntry entry <span class="keyword">in</span> newEntriesList) &#123;</span><br><span class="line">      entry._overlay ??= <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _entries.clear();</span><br><span class="line">      _entries.addAll(newEntriesList);</span><br><span class="line">      old.removeAll(newEntriesList);</span><br><span class="line">      _entries.insertAll(_insertionIndex(below, above), old);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _remove(OverlayEntry entry) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mounted) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _entries.remove(entry);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> debugIsVisible(OverlayEntry entry) &#123;</span><br><span class="line">    <span class="built_in">bool</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _didChangeEntryOpacity() &#123;</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; onstageChildren = &lt;Widget&gt;[];</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; offstageChildren = &lt;Widget&gt;[];</span><br><span class="line">    <span class="built_in">bool</span> onstage = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 从最后一个开始遍历</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = _entries.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> OverlayEntry entry = _entries[i];</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (onstage) &#123;</span><br><span class="line">        onstageChildren.add(_OverlayEntry(entry));</span><br><span class="line">        <span class="comment">// 如果当前层为遮挡, 则其他层默认不加入 tree</span></span><br><span class="line">        <span class="keyword">if</span> (entry.opaque)</span><br><span class="line">          onstage = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// 除非 maintainState 为 true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.maintainState) &#123;</span><br><span class="line">        offstageChildren.add(TickerMode(enabled: <span class="keyword">false</span>, child: _OverlayEntry(entry)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _Theatre(</span><br><span class="line">      onstage: Stack(</span><br><span class="line">        fit: StackFit.expand,</span><br><span class="line">        children: onstageChildren.reversed.toList(growable: <span class="keyword">false</span>),</span><br><span class="line">      ),</span><br><span class="line">      offstage: offstageChildren,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Theatre</span> <span class="keyword">extends</span> <span class="title">RenderObjectWidget</span> </span>&#123;</span><br><span class="line">  _Theatre(&#123;</span><br><span class="line">    <span class="keyword">this</span>.onstage,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.offstage,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Stack onstage;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; offstage;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TheatreElement createElement() =&gt; _TheatreElement(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _RenderTheatre createRenderObject(BuildContext context) =&gt; _RenderTheatre();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TheatreElement</span> <span class="keyword">extends</span> <span class="title">RenderObjectElement</span> </span>&#123;</span><br><span class="line">  _TheatreElement(_Theatre widget)</span><br><span class="line">    : <span class="keyword">super</span>(widget);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _Theatre <span class="keyword">get</span> widget =&gt; <span class="keyword">super</span>.widget;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _RenderTheatre <span class="keyword">get</span> renderObject =&gt; <span class="keyword">super</span>.renderObject;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Element</span> _onstage;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">Object</span> _onstageSlot = <span class="built_in">Object</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">Element</span>&gt; _offstage;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Set</span>&lt;<span class="built_in">Element</span>&gt; _forgottenOffstageChildren = HashSet&lt;<span class="built_in">Element</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> insertChildRenderObject(RenderBox child, <span class="built_in">dynamic</span> slot) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slot == _onstageSlot) &#123;</span><br><span class="line">      renderObject.child = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      renderObject.insert(child, after: slot?.renderObject);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> moveChildRenderObject(RenderBox child, <span class="built_in">dynamic</span> slot) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slot == _onstageSlot) &#123;</span><br><span class="line">      renderObject.remove(child);</span><br><span class="line">      renderObject.child = child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (renderObject.child == child) &#123;</span><br><span class="line">        renderObject.child = <span class="keyword">null</span>;</span><br><span class="line">        renderObject.insert(child, after: slot?.renderObject);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        renderObject.move(child, after: slot?.renderObject);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> removeChildRenderObject(RenderBox child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (renderObject.child == child) &#123;</span><br><span class="line">      renderObject.child = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      renderObject.remove(child);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> visitChildren(ElementVisitor visitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_onstage != <span class="keyword">null</span>)</span><br><span class="line">      visitor(_onstage);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">Element</span> child <span class="keyword">in</span> _offstage) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!_forgottenOffstageChildren.contains(child))</span><br><span class="line">        visitor(child);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> debugVisitOnstageChildren(ElementVisitor visitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_onstage != <span class="keyword">null</span>)</span><br><span class="line">      visitor(_onstage);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> forgetChild(<span class="built_in">Element</span> child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child == _onstage) &#123;</span><br><span class="line">      _onstage = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _forgottenOffstageChildren.add(child);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> mount(<span class="built_in">Element</span> parent, <span class="built_in">dynamic</span> newSlot) &#123;</span><br><span class="line">    <span class="keyword">super</span>.mount(parent, newSlot);</span><br><span class="line">    _onstage = updateChild(_onstage, widget.onstage, _onstageSlot);</span><br><span class="line">    _offstage = <span class="built_in">List</span>&lt;<span class="built_in">Element</span>&gt;(widget.offstage.length);</span><br><span class="line">    <span class="built_in">Element</span> previousChild;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _offstage.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="built_in">Element</span> newChild = inflateWidget(widget.offstage[i], previousChild);</span><br><span class="line">      _offstage[i] = newChild;</span><br><span class="line">      previousChild = newChild;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> update(_Theatre newWidget) &#123;</span><br><span class="line">    <span class="keyword">super</span>.update(newWidget);</span><br><span class="line">    _onstage = updateChild(_onstage, widget.onstage, _onstageSlot);</span><br><span class="line">    _offstage = updateChildren(_offstage, widget.offstage, forgottenChildren: _forgottenOffstageChildren);</span><br><span class="line">    _forgottenOffstageChildren.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_RenderTheatre</span> <span class="keyword">extends</span> <span class="title">RenderBox</span></span></span><br><span class="line"><span class="class">  <span class="title">with</span> <span class="title">RenderObjectWithChildMixin</span>&lt;<span class="title">RenderStack</span>&gt;, <span class="title">RenderProxyBoxMixin</span>&lt;<span class="title">RenderStack</span>&gt;,</span></span><br><span class="line"><span class="class">       <span class="title">ContainerRenderObjectMixin</span>&lt;<span class="title">RenderBox</span>, <span class="title">StackParentData</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> setupParentData(RenderObject child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child.parentData <span class="keyword">is</span>! StackParentData)</span><br><span class="line">      child.parentData = StackParentData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> redepthChildren() &#123;</span><br><span class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</span><br><span class="line">      redepthChild(child);</span><br><span class="line">    <span class="keyword">super</span>.redepthChildren();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> visitChildren(RenderObjectVisitor visitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</span><br><span class="line">      visitor(child);</span><br><span class="line">    <span class="keyword">super</span>.visitChildren(visitor);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">List</span>&lt;DiagnosticsNode&gt; debugDescribeChildren() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">List</span>&lt;DiagnosticsNode&gt; children = &lt;DiagnosticsNode&gt;[];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</span><br><span class="line">      children.add(child.toDiagnosticsNode(name: <span class="string">&#x27;onstage&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (firstChild != <span class="keyword">null</span>) &#123;</span><br><span class="line">      RenderBox child = firstChild;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">int</span> count = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        children.add(</span><br><span class="line">          child.toDiagnosticsNode(</span><br><span class="line">            name: <span class="string">&#x27;offstage <span class="subst">$count</span>&#x27;</span>,</span><br><span class="line">            style: DiagnosticsTreeStyle.offstage,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (child == lastChild)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">final</span> StackParentData childParentData = child.parentData;</span><br><span class="line">        child = childParentData.nextSibling;</span><br><span class="line">        count += <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      children.add(</span><br><span class="line">        DiagnosticsNode.message(</span><br><span class="line">          <span class="string">&#x27;no offstage children&#x27;</span>,</span><br><span class="line">          style: DiagnosticsTreeStyle.offstage,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> visitChildrenForSemantics(RenderObjectVisitor visitor) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child != <span class="keyword">null</span>)</span><br><span class="line">      visitor(child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ok, 到此就大致讲完了<code>Navigator</code>. 我们讲一下路由相关类.</p>
<h3 id="路由相关类"><a href="#路由相关类" class="headerlink" title="路由相关类"></a>路由相关类</h3><h4 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  Route(&#123; RouteSettings settings &#125;) : settings = settings ?? <span class="keyword">const</span> RouteSettings();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 归属的导航器. 在 install 中注册.</span></span><br><span class="line">  NavigatorState <span class="keyword">get</span> navigator =&gt; _navigator;</span><br><span class="line">  NavigatorState _navigator;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> RouteSettings settings;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 该 route 的所有 OverlayEntry</span></span><br><span class="line">  <span class="built_in">List</span>&lt;OverlayEntry&gt; <span class="keyword">get</span> overlayEntries =&gt; <span class="keyword">const</span> &lt;OverlayEntry&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当被插入到导航器时被调用.如果当前 route 是第一个加入的 route, 则 参数 </span></span><br><span class="line">  <span class="comment">// insertionPoint 为 null. </span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> install(OverlayEntry insertionPoint) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 install 后被调用.</span></span><br><span class="line">  <span class="comment">// 当过渡完成时, 返回的 Future 会被结束.</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  TickerFuture didPush() =&gt; TickerFuture.complete();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 install 中替换了其他 route 后被调用</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> didReplace(Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Navigator.maybePop 会调用.</span></span><br><span class="line">  Future&lt;RoutePopDisposition&gt; willPop() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> isFirst ? RoutePopDisposition.bubble : RoutePopDisposition.pop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 didPop 是否返回 false</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> willHandlePopInternally =&gt; <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Navigator.pop 返回的默认结果</span></span><br><span class="line">  T <span class="keyword">get</span> currentResult =&gt; <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  Future&lt;T&gt; <span class="keyword">get</span> popped =&gt; _popCompleter.future;</span><br><span class="line">  <span class="keyword">final</span> Completer&lt;T&gt; _popCompleter = Completer&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="built_in">bool</span> didPop(T result) &#123;</span><br><span class="line">    didComplete(result);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> didComplete(T result) &#123;</span><br><span class="line">    _popCompleter.complete(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> didPopNext(Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> didChangeNext(Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> didChangePrevious(Route&lt;<span class="built_in">dynamic</span>&gt; previousRoute) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 内部数据改变</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> changedInternalState() &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Navigator.widget 改变了</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="keyword">void</span> changedExternalState() &#123; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回收</span></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _navigator = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否是页面栈顶</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isCurrent &#123;</span><br><span class="line">    <span class="keyword">return</span> _navigator != <span class="keyword">null</span> &amp;&amp; _navigator._history.last == <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isFirst &#123;</span><br><span class="line">    <span class="keyword">return</span> _navigator != <span class="keyword">null</span> &amp;&amp; _navigator._history.first == <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> isActive &#123;</span><br><span class="line">    <span class="keyword">return</span> _navigator != <span class="keyword">null</span> &amp;&amp; _navigator._history.contains(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="OverlayRoute"><a href="#OverlayRoute" class="headerlink" title="OverlayRoute"></a>OverlayRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OverlayRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Route</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  OverlayRoute(&#123;</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Iterable</span>&lt;OverlayEntry&gt; createOverlayEntries();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">List</span>&lt;OverlayEntry&gt; <span class="keyword">get</span> overlayEntries =&gt; _overlayEntries;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;OverlayEntry&gt; _overlayEntries = &lt;OverlayEntry&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> install(OverlayEntry insertionPoint) &#123;</span><br><span class="line">    _overlayEntries.addAll(createOverlayEntries());</span><br><span class="line">    navigator.overlay?.insertAll(_overlayEntries, above: insertionPoint);</span><br><span class="line">    <span class="keyword">super</span>.install(insertionPoint);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制 didPop 是否调用 [NavigatorState.finalizeRoute]</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> finishedWhenPopped =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> didPop(T result) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> returnValue = <span class="keyword">super</span>.didPop(result);</span><br><span class="line">    <span class="keyword">if</span> (finishedWhenPopped)</span><br><span class="line">      navigator.finalizeRoute(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="keyword">for</span> (OverlayEntry entry <span class="keyword">in</span> _overlayEntries)</span><br><span class="line">      entry.remove();</span><br><span class="line">    _overlayEntries.clear();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="TransitionRoute"><a href="#TransitionRoute" class="headerlink" title="TransitionRoute"></a>TransitionRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TransitionRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">OverlayRoute</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  TransitionRoute(&#123;</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings);</span><br><span class="line"></span><br><span class="line">  Future&lt;T&gt; <span class="keyword">get</span> completed =&gt; _transitionCompleter.future;</span><br><span class="line">  <span class="keyword">final</span> Completer&lt;T&gt; _transitionCompleter = Completer&lt;T&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 过渡时间</span></span><br><span class="line">  <span class="built_in">Duration</span> <span class="keyword">get</span> transitionDuration;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否遮挡</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> opaque;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> finishedWhenPopped =&gt; _controller.status == AnimationStatus.dismissed;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 驱动当前路由和前一个路由的过渡</span></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> animation =&gt; _animation;</span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; _animation;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制器</span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  AnimationController <span class="keyword">get</span> controller =&gt; _controller;</span><br><span class="line">  AnimationController _controller;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对当前路由之上新入栈的路由的动画.</span></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> secondaryAnimation =&gt; _secondaryAnimation;</span><br><span class="line">  <span class="keyword">final</span> ProxyAnimation _secondaryAnimation = ProxyAnimation(kAlwaysDismissedAnimation);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建控制器.</span></span><br><span class="line">  AnimationController createAnimationController() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">Duration</span> duration = transitionDuration;</span><br><span class="line">    <span class="keyword">return</span> AnimationController(</span><br><span class="line">      duration: duration,</span><br><span class="line">      debugLabel: debugLabel,</span><br><span class="line">      vsync: navigator,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回动画对象</span></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; createAnimation() &#123;</span><br><span class="line">    <span class="keyword">return</span> _controller.view;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  T _result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _handleStatusChanged(AnimationStatus status) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">      <span class="keyword">case</span> AnimationStatus.completed:</span><br><span class="line">        <span class="keyword">if</span> (overlayEntries.isNotEmpty)</span><br><span class="line">          overlayEntries.first.opaque = opaque;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> AnimationStatus.forward:</span><br><span class="line">      <span class="keyword">case</span> AnimationStatus.reverse:</span><br><span class="line">        <span class="keyword">if</span> (overlayEntries.isNotEmpty)</span><br><span class="line">          overlayEntries.first.opaque = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> AnimationStatus.dismissed:</span><br><span class="line">        <span class="keyword">if</span> (!isActive) &#123;</span><br><span class="line">          navigator.finalizeRoute(<span class="keyword">this</span>);</span><br><span class="line">          <span class="keyword">assert</span>(overlayEntries.isEmpty);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    changedInternalState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> install(OverlayEntry insertionPoint) &#123;</span><br><span class="line">    _controller = createAnimationController();</span><br><span class="line">    _animation = createAnimation();</span><br><span class="line">    <span class="keyword">super</span>.install(insertionPoint);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  TickerFuture didPush() &#123;</span><br><span class="line">    _animation.addStatusListener(_handleStatusChanged);</span><br><span class="line">    <span class="keyword">return</span> _controller.forward();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didReplace(Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute) &#123;</span><br><span class="line">    <span class="keyword">if</span> (oldRoute <span class="keyword">is</span> TransitionRoute)</span><br><span class="line">      _controller.value = oldRoute._controller.value;</span><br><span class="line">    _animation.addStatusListener(_handleStatusChanged);</span><br><span class="line">    <span class="keyword">super</span>.didReplace(oldRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> didPop(T result) &#123;</span><br><span class="line">    _result = result;</span><br><span class="line">    _controller.reverse();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.didPop(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didPopNext(Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123;</span><br><span class="line">    _updateSecondaryAnimation(nextRoute);</span><br><span class="line">    <span class="keyword">super</span>.didPopNext(nextRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeNext(Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123;</span><br><span class="line">    _updateSecondaryAnimation(nextRoute);</span><br><span class="line">    <span class="keyword">super</span>.didChangeNext(nextRoute);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _updateSecondaryAnimation(Route&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextRoute <span class="keyword">is</span> TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; &amp;&amp; canTransitionTo(nextRoute) &amp;&amp; nextRoute.canTransitionFrom(<span class="keyword">this</span>)) &#123;</span><br><span class="line">      <span class="keyword">final</span> Animation&lt;<span class="built_in">double</span>&gt; current = _secondaryAnimation.parent;</span><br><span class="line">      <span class="keyword">if</span> (current != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (current <span class="keyword">is</span> TrainHoppingAnimation) &#123;</span><br><span class="line">          TrainHoppingAnimation newAnimation;</span><br><span class="line">          newAnimation = TrainHoppingAnimation(</span><br><span class="line">            current.currentTrain,</span><br><span class="line">            nextRoute._animation,</span><br><span class="line">            onSwitchedTrain: () &#123;</span><br><span class="line">              _secondaryAnimation.parent = newAnimation.currentTrain;</span><br><span class="line">              newAnimation.dispose();</span><br><span class="line">            &#125;,</span><br><span class="line">          );</span><br><span class="line">          _secondaryAnimation.parent = newAnimation;</span><br><span class="line">          current.dispose();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          _secondaryAnimation.parent = TrainHoppingAnimation(current, nextRoute._animation);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _secondaryAnimation.parent = nextRoute._animation;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _secondaryAnimation.parent = kAlwaysDismissedAnimation;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> canTransitionTo(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; nextRoute) =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> canTransitionFrom(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; previousRoute) =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _controller?.dispose();</span><br><span class="line">    _transitionCompleter.complete(_result);</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> <span class="keyword">get</span> debugLabel =&gt; <span class="string">&#x27;<span class="subst">$runtimeType</span>&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="LocalHostory"><a href="#LocalHostory" class="headerlink" title="LocalHostory"></a>LocalHostory</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocalHistoryEntry</span> </span>&#123;</span><br><span class="line">  LocalHistoryEntry(&#123; <span class="keyword">this</span>.onRemove &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> VoidCallback onRemove;</span><br><span class="line"></span><br><span class="line">  LocalHistoryRoute&lt;<span class="built_in">dynamic</span>&gt; _owner;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> remove() &#123;</span><br><span class="line">    _owner.removeLocalHistoryEntry(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _notifyRemoved() &#123;</span><br><span class="line">    <span class="keyword">if</span> (onRemove != <span class="keyword">null</span>)</span><br><span class="line">      onRemove();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mixin</span> LocalHistoryRoute&lt;T&gt; <span class="keyword">on</span> Route&lt;T&gt; &#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;LocalHistoryEntry&gt; _localHistory;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> addLocalHistoryEntry(LocalHistoryEntry entry) &#123;</span><br><span class="line">    entry._owner = <span class="keyword">this</span>;</span><br><span class="line">    _localHistory ??= &lt;LocalHistoryEntry&gt;[];</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">bool</span> wasEmpty = _localHistory.isEmpty;</span><br><span class="line">    _localHistory.add(entry);</span><br><span class="line">    <span class="keyword">if</span> (wasEmpty)</span><br><span class="line">      changedInternalState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> removeLocalHistoryEntry(LocalHistoryEntry entry) &#123;</span><br><span class="line">    _localHistory.remove(entry);</span><br><span class="line">    entry._owner = <span class="keyword">null</span>;</span><br><span class="line">    entry._notifyRemoved();</span><br><span class="line">    <span class="keyword">if</span> (_localHistory.isEmpty)</span><br><span class="line">      changedInternalState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;RoutePopDisposition&gt; willPop() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (willHandlePopInternally)</span><br><span class="line">      <span class="keyword">return</span> RoutePopDisposition.pop;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">super</span>.willPop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> didPop(T result) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_localHistory != <span class="keyword">null</span> &amp;&amp; _localHistory.isNotEmpty) &#123;</span><br><span class="line">      <span class="keyword">final</span> LocalHistoryEntry entry = _localHistory.removeLast();</span><br><span class="line">      entry._owner = <span class="keyword">null</span>;</span><br><span class="line">      entry._notifyRemoved();</span><br><span class="line">      <span class="keyword">if</span> (_localHistory.isEmpty)</span><br><span class="line">        changedInternalState();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.didPop(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> willHandlePopInternally &#123;</span><br><span class="line">    <span class="keyword">return</span> _localHistory != <span class="keyword">null</span> &amp;&amp; _localHistory.isNotEmpty;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ModalRoute"><a href="#ModalRoute" class="headerlink" title="ModalRoute"></a>ModalRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ModalRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">TransitionRoute</span>&lt;<span class="title">T</span>&gt; <span class="title">with</span> <span class="title">LocalHistoryRoute</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  ModalRoute(&#123;</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The API for general users of this class</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@optionalTypeArgs</span></span><br><span class="line">  <span class="keyword">static</span> ModalRoute&lt;T&gt; of&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> _ModalScopeStatus widget = context.inheritFromWidgetOfExactType(_ModalScopeStatus);</span><br><span class="line">    <span class="keyword">return</span> widget?.route;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 安排调用 [buildTransitions]. </span></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="keyword">void</span> setState(VoidCallback fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_scopeKey.currentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">      _scopeKey.currentState._routeSetState(fn);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fn();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> RoutePredicate withName(<span class="built_in">String</span> name) &#123;</span><br><span class="line">    <span class="keyword">return</span> (Route&lt;<span class="built_in">dynamic</span>&gt; route) &#123;</span><br><span class="line">      <span class="keyword">return</span> !route.willHandlePopInternally</span><br><span class="line">          &amp;&amp; route <span class="keyword">is</span> ModalRoute</span><br><span class="line">          &amp;&amp; route.settings.name == name;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The API for subclasses to override - used by _ModalScope</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  Widget buildPage(BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation, Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation);</span><br><span class="line"></span><br><span class="line">  Widget buildTransitions(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation,</span><br><span class="line">    Widget child,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> install(OverlayEntry insertionPoint) &#123;</span><br><span class="line">    <span class="keyword">super</span>.install(insertionPoint);</span><br><span class="line">    _animationProxy = ProxyAnimation(<span class="keyword">super</span>.animation);</span><br><span class="line">    _secondaryAnimationProxy = ProxyAnimation(<span class="keyword">super</span>.secondaryAnimation);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  TickerFuture didPush() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_scopeKey.currentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">      navigator.focusScopeNode.setFirstFocus(_scopeKey.currentState.focusScopeNode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.didPush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The API for subclasses to override - used by this class</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> barrierDismissible;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> semanticsDismissible =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  Color <span class="keyword">get</span> barrierColor;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> <span class="keyword">get</span> barrierLabel;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> maintainState;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The API for _ModalScope and HeroController</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前路由是否是否离屏.</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> offstage =&gt; _offstage;</span><br><span class="line">  <span class="built_in">bool</span> _offstage = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">set</span> offstage(<span class="built_in">bool</span> value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_offstage == value)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _offstage = value;</span><br><span class="line">    &#125;);</span><br><span class="line">    _animationProxy.parent = _offstage ? kAlwaysCompleteAnimation : <span class="keyword">super</span>.animation;</span><br><span class="line">    _secondaryAnimationProxy.parent = _offstage ? kAlwaysDismissedAnimation : <span class="keyword">super</span>.secondaryAnimation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// <span class="markdown">The build context for the subtree containing the primary content of this route.</span></span></span><br><span class="line">  BuildContext <span class="keyword">get</span> subtreeContext =&gt; _subtreeKey.currentContext;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> animation =&gt; _animationProxy;</span><br><span class="line">  ProxyAnimation _animationProxy;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> secondaryAnimation =&gt; _secondaryAnimationProxy;</span><br><span class="line">  ProxyAnimation _secondaryAnimationProxy;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;WillPopCallback&gt; _willPopCallbacks = &lt;WillPopCallback&gt;[];</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Future&lt;RoutePopDisposition&gt; willPop() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> _ModalScopeState&lt;T&gt; scope = _scopeKey.currentState;</span><br><span class="line">    <span class="keyword">for</span> (WillPopCallback callback <span class="keyword">in</span> <span class="built_in">List</span>&lt;WillPopCallback&gt;.from(_willPopCallbacks)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">await</span> callback())</span><br><span class="line">        <span class="keyword">return</span> RoutePopDisposition.doNotPop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">super</span>.willPop();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> addScopedWillPopCallback(WillPopCallback callback) &#123;</span><br><span class="line">    _willPopCallbacks.add(callback);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> removeScopedWillPopCallback(WillPopCallback callback) &#123;</span><br><span class="line">    _willPopCallbacks.remove(callback);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> hasScopedWillPopCallback &#123;</span><br><span class="line">    <span class="keyword">return</span> _willPopCallbacks.isNotEmpty;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangePrevious(Route&lt;<span class="built_in">dynamic</span>&gt; previousRoute) &#123;</span><br><span class="line">    <span class="keyword">super</span>.didChangePrevious(previousRoute);</span><br><span class="line">    changedInternalState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> changedInternalState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.changedInternalState();</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">    _modalBarrier.markNeedsBuild();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> changedExternalState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.changedExternalState();</span><br><span class="line">    <span class="keyword">if</span> (_scopeKey.currentState != <span class="keyword">null</span>)</span><br><span class="line">      _scopeKey.currentState._forceRebuildPage();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> canPop =&gt; !isFirst || willHandlePopInternally;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Internals</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> GlobalKey&lt;_ModalScopeState&lt;T&gt;&gt; _scopeKey = GlobalKey&lt;_ModalScopeState&lt;T&gt;&gt;();</span><br><span class="line">  <span class="keyword">final</span> GlobalKey _subtreeKey = GlobalKey();</span><br><span class="line">  <span class="keyword">final</span> PageStorageBucket _storageBucket = PageStorageBucket();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Animatable&lt;<span class="built_in">double</span>&gt; _easeCurveTween = CurveTween(curve: Curves.ease);</span><br><span class="line"></span><br><span class="line">  OverlayEntry _modalBarrier;</span><br><span class="line">  Widget _buildModalBarrier(BuildContext context) &#123;</span><br><span class="line">    Widget barrier;</span><br><span class="line">    <span class="keyword">if</span> (barrierColor != <span class="keyword">null</span> &amp;&amp; !offstage) &#123;</span><br><span class="line">      <span class="keyword">final</span> Animation&lt;Color&gt; color = animation.drive(</span><br><span class="line">        ColorTween(</span><br><span class="line">          begin: _kTransparent,</span><br><span class="line">          end: barrierColor,</span><br><span class="line">        ).chain(_easeCurveTween),</span><br><span class="line">      );</span><br><span class="line">      barrier = AnimatedModalBarrier(</span><br><span class="line">        color: color,</span><br><span class="line">        dismissible: barrierDismissible,</span><br><span class="line">        semanticsLabel: barrierLabel,</span><br><span class="line">        barrierSemanticsDismissible: semanticsDismissible,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      barrier = ModalBarrier(</span><br><span class="line">        dismissible: barrierDismissible,</span><br><span class="line">        semanticsLabel: barrierLabel,</span><br><span class="line">        barrierSemanticsDismissible: semanticsDismissible,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> IgnorePointer(</span><br><span class="line">      ignoring: animation.status == AnimationStatus.reverse || </span><br><span class="line">                animation.status == AnimationStatus.dismissed,</span><br><span class="line">      child: barrier,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget _modalScopeCache;</span><br><span class="line"></span><br><span class="line">  Widget _buildModalScope(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> _modalScopeCache ??= _ModalScope&lt;T&gt;(</span><br><span class="line">      key: _scopeKey,</span><br><span class="line">      route: <span class="keyword">this</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">Iterable</span>&lt;OverlayEntry&gt; createOverlayEntries() <span class="keyword">sync</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> _modalBarrier = OverlayEntry(builder: _buildModalBarrier);</span><br><span class="line">    <span class="keyword">yield</span> OverlayEntry(builder: _buildModalScope, maintainState: maintainState);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="PopupRoute"><a href="#PopupRoute" class="headerlink" title="PopupRoute"></a>PopupRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PopupRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ModalRoute</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  PopupRoute(&#123;</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> opaque =&gt; <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> maintainState =&gt; <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="PageRoute"><a href="#PageRoute" class="headerlink" title="PageRoute"></a>PageRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PageRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ModalRoute</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  PageRoute(&#123;</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">    <span class="keyword">this</span>.fullscreenDialog = <span class="keyword">false</span>,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> fullscreenDialog;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> opaque =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> barrierDismissible =&gt; <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> canTransitionTo(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; nextRoute) =&gt; nextRoute <span class="keyword">is</span> PageRoute;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> canTransitionFrom(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; previousRoute) =&gt; previousRoute <span class="keyword">is</span> PageRoute;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  AnimationController createAnimationController() &#123;</span><br><span class="line">    <span class="keyword">final</span> AnimationController controller = <span class="keyword">super</span>.createAnimationController();</span><br><span class="line">    <span class="keyword">if</span> (settings.isInitialRoute)</span><br><span class="line">      controller.value = <span class="number">1.0</span>;</span><br><span class="line">    <span class="keyword">return</span> controller;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="MaterialPageRoute"><a href="#MaterialPageRoute" class="headerlink" title="MaterialPageRoute"></a>MaterialPageRoute</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaterialPageRoute</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">PageRoute</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  MaterialPageRoute(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">    RouteSettings settings,</span><br><span class="line">    <span class="keyword">this</span>.maintainState = <span class="keyword">true</span>,</span><br><span class="line">    <span class="built_in">bool</span> fullscreenDialog = <span class="keyword">false</span>,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(settings: settings, fullscreenDialog: fullscreenDialog);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> WidgetBuilder builder;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> maintainState;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">Duration</span> <span class="keyword">get</span> transitionDuration =&gt; <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Color <span class="keyword">get</span> barrierColor =&gt; <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> <span class="keyword">get</span> barrierLabel =&gt; <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> canTransitionFrom(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; previousRoute) &#123;</span><br><span class="line">    <span class="keyword">return</span> previousRoute <span class="keyword">is</span> MaterialPageRoute || previousRoute <span class="keyword">is</span> CupertinoPageRoute;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> canTransitionTo(TransitionRoute&lt;<span class="built_in">dynamic</span>&gt; nextRoute) &#123;</span><br><span class="line">    <span class="keyword">return</span> (nextRoute <span class="keyword">is</span> MaterialPageRoute &amp;&amp; !nextRoute.fullscreenDialog)</span><br><span class="line">        || (nextRoute <span class="keyword">is</span> CupertinoPageRoute &amp;&amp; !nextRoute.fullscreenDialog);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget buildPage(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation,</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">final</span> Widget result = builder(context);</span><br><span class="line">    <span class="keyword">assert</span>(() &#123;</span><br><span class="line">      <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> FlutterError(</span><br><span class="line">          <span class="string">&#x27;The builder for route &quot;<span class="subst">$&#123;settings.name&#125;</span>&quot; returned null.\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;Route builders must never return null.&#x27;</span></span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;());</span><br><span class="line">    <span class="keyword">return</span> Semantics(</span><br><span class="line">      scopesRoute: <span class="keyword">true</span>,</span><br><span class="line">      explicitChildNodes: <span class="keyword">true</span>,</span><br><span class="line">      child: result,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget buildTransitions(BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation, Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation, Widget child) &#123;</span><br><span class="line">    <span class="keyword">final</span> PageTransitionsTheme theme = Theme.of(context).pageTransitionsTheme;</span><br><span class="line">    <span class="keyword">return</span> theme.buildTransitions&lt;T&gt;(<span class="keyword">this</span>, context, animation, secondaryAnimation, child);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="操作路由"><a href="#操作路由" class="headerlink" title="操作路由"></a>操作路由</h2><p>从入栈一个路由开始</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Navigator.of(context).push(PageRoute());</span><br></pre></td></tr></table></figure>
<p>对，首先来到这：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NavigatorState</span></span><br><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line">Future&lt;T&gt; push&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(Route&lt;T&gt; route) &#123;</span><br><span class="line">  <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; oldRoute = _history.isNotEmpty ? _history.last : <span class="keyword">null</span>;</span><br><span class="line">  route._navigator = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 安装 entry</span></span><br><span class="line">  route.install(_currentOverlayEntry);</span><br><span class="line">  <span class="comment">// 添加历史</span></span><br><span class="line">  _history.add(route);</span><br><span class="line">  <span class="comment">// 触发相关回调</span></span><br><span class="line">  route.didPush();</span><br><span class="line">  route.didChangeNext(<span class="keyword">null</span>);</span><br><span class="line">  <span class="keyword">if</span> (oldRoute != <span class="keyword">null</span>) &#123;</span><br><span class="line">    oldRoute.didChangeNext(route);</span><br><span class="line">    route.didChangePrevious(oldRoute);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 触发观察者列表</span></span><br><span class="line">  <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">    observer.didPush(route, oldRoute);</span><br><span class="line">  RouteNotificationMessages.maybeNotifyRouteChange(_routePushedMethod, route, oldRoute);</span><br><span class="line">  <span class="keyword">assert</span>(() &#123; _debugLocked = <span class="keyword">false</span>; <span class="keyword">return</span> <span class="keyword">true</span>; &#125;());</span><br><span class="line">  _afterNavigation(route);</span><br><span class="line">  <span class="keyword">return</span> route.popped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当该层路由被弹出时，该方法才会返回。</p>
<p>当出栈时，及调用 Navigator.pop() 或者 maybePop()  （这里不讨论 popUntil 等其他形式）时：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> pop&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;([ T result ]) &#123;</span><br><span class="line">  <span class="comment">// 去除最后一个（即当前）</span></span><br><span class="line">  <span class="keyword">final</span> Route&lt;<span class="built_in">dynamic</span>&gt; route = _history.last;</span><br><span class="line">  <span class="built_in">bool</span> debugPredictedWouldPop;</span><br><span class="line">  <span class="keyword">if</span> (route.didPop(result ?? route.currentResult)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (_history.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      _history.removeLast();</span><br><span class="line">      <span class="comment">// If route._navigator is null, the route called finalizeRoute from</span></span><br><span class="line">      <span class="comment">// didPop, which means the route has already been disposed and doesn&#x27;t</span></span><br><span class="line">      <span class="comment">// need to be added to _poppedRoutes for later disposal.</span></span><br><span class="line">      <span class="keyword">if</span> (route._navigator != <span class="keyword">null</span>)</span><br><span class="line">        _poppedRoutes.add(route);</span><br><span class="line">      _history.last.didPopNext(route);</span><br><span class="line">      <span class="keyword">for</span> (NavigatorObserver observer <span class="keyword">in</span> widget.observers)</span><br><span class="line">        observer.didPop(route, _history.last);</span><br><span class="line">      RouteNotificationMessages.maybeNotifyRouteChange(_routePoppedMethod, route, _history.last);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  _afterNavigation&lt;<span class="built_in">dynamic</span>&gt;(route);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="基于路由相关的设计"><a href="#基于路由相关的设计" class="headerlink" title="基于路由相关的设计"></a>基于路由相关的设计</h2><h3 id="弹层"><a href="#弹层" class="headerlink" title="弹层"></a>弹层</h3><p>当一个弹层被加入到路由栈时，会使原路由顶的所有事件失效。此时，一些不该影响交互的组件，比如回到顶部这种组件，应该是不会中断原来的滚动的。因此对于这种情况，需要采用另一种方案：给当前 OverlayState 添加新的 OverlayEntry 即可。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/flutter-route/" rel="tag"># flutter-route</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/10/04/flutter%E4%B8%ADwidget-element-renderObject%E5%85%B3%E7%B3%BB/" rel="prev" title="flutter中widget/element/renderObject关系">
                  <i class="fa fa-chevron-left"></i> flutter中widget/element/renderObject关系
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/12/12/%E7%AC%AC%E4%B8%80%E8%AE%B2-flutter/" rel="next" title="flutter 介绍">
                  flutter 介绍 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81MjY5OS8yOTE3Ng=="></div><script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class=""></i>
  </span>
  <span class="author" itemprop="copyrightHolder">谭智轩</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  




<script src="/js/third-party/comments/livere.js"></script>

</body>
</html>
